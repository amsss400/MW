stages:
  - build

# JOB ANDROID RELEASE (Sign√©) - MANUEL
build_android_release:
  stage: build
  when: manual
  image: reactnativecommunity/react-native-android:latest
  tags:
    - saas-linux-medium-amd64
  before_script:
    - npm install --legacy-peer-deps
    - apt-get update && apt-get install -y xxd
    - echo "$KEYSTORE_FILE_HEX" | xxd -r -p > android/app/release.keystore
  script:
    - echo "üîê G√©n√©ration de l'APK Sign√© (Release)..."
    - cd android
    - chmod +x gradlew
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - android/app/build/outputs/apk/release/app-release.apk
    expire_in: 1 week

# JOB iOS (V√©rification) - MANUEL
# Optimis√© pour √©viter le crash "remote command exited"
build_ios_check:
  stage: build
  when: manual
  tags:
    - saas-macos-medium-m1
  image: macos-14-xcode-15
  before_script:
    # On nettoie le cache pour √©viter les fichiers corrompus
    - npm cache clean --force
    # L'option --ignore-scripts est CRUCIALE ici : elle emp√™che le crash du runner
    - npm install --legacy-peer-deps --ignore-scripts --no-audit --no-fund
    - cd ios
    - pod install
  script:
    - echo "üçè V√©rification du code iOS..."
    - xcodebuild -workspace MalinWallet.xcworkspace -scheme MalinWallet -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' build CODE_SIGNING_ALLOWED=NO
